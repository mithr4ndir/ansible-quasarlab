- name: Dump default containerd config (once only)
  ansible.builtin.shell: containerd config default | tee /etc/containerd/config.toml > /dev/null
  args:
    creates: /etc/containerd/config.toml
  become: true

- name: Enable SystemdCgroup in containerd (only if file is present)
  ansible.builtin.replace:
    path: /etc/containerd/config.toml
    regexp: 'SystemdCgroup = false'
    replace: 'SystemdCgroup = true'
    backup: yes
  register: cgroup_replaced
  become: true

- name: Restart containerd only if config was changed
  ansible.builtin.service:
    name: containerd
    state: restarted
  when: cgroup_replaced is changed
  become: true
