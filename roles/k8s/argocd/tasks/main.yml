- name: Ensure Argo CD namespace exists
  kubernetes.core.k8s:
    api_version: v1
    kind: Namespace
    name: "{{ argocd_namespace }}"
    state: present
    kubeconfig: "{{ kubeconfig_path }}"

- name: Install Argo CD HA manifests
  kubernetes.core.k8s:
    state: present
    src: "https://raw.githubusercontent.com/argoproj/argo-cd/{{ argocd_version }}/manifests/ha/install.yaml"
    namespace: "{{ argocd_namespace }}"
    kubeconfig: "{{ kubeconfig_path }}"

- name: Patch Argo CD Server service to LoadBalancer
  kubernetes.core.k8s:
    state: patched
    kind: Service
    api_version: v1
    name: argocd-server
    namespace: "{{ argocd_namespace }}"
    merge_type: strategic-merge
    definition:
      spec:
        type: "{{ argocd_server_service_type }}"
    kubeconfig: "{{ kubeconfig_path }}"

- name: Wait for Argo CD server deployment to be ready
  kubernetes.core.k8s_info:
    api_version: apps/v1
    kind: Deployment
    name: argocd-server
    namespace: "{{ argocd_namespace }}"
    kubeconfig: "{{ kubeconfig_path }}"
  register: argo_deploy
  until: argo_deploy.resources[0].status.availableReplicas | default(0) >= 1
  retries: 15
  delay: 10

- name: Bootstrap ApplicationSet for environment discovery
  kubernetes.core.k8s:
    state: present
    definition: "{{ lookup('file', 'files/argocd-applicationset.yaml') | from_yaml }}"
    kubeconfig: "{{ kubeconfig_path }}"
